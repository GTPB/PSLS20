---
title: "Tutorial 3.1: Non-parametric analysis in the NHANES dataset"   
output:
    html_document:
      code_download: true    
      theme: cosmo
      toc: true
      toc_float: true
      highlight: tango
      number_sections: true
---

To experiment with the concepts of non-parametric analysis
and sampling, we will again work with the NHANES dataset.

## The NHANES dataset

The National Health and Nutrition Examination Survey (NHANES)
contains data that has been collected since 1960. For this tutorial,
we will make use of the data that were collected between 2009 and 
2012, for 10.000 U.S. civilians. The dataset contains a large number of
physical, demographic, nutritional and life-style-related parameters.

## Load the required libraries

```{r, message = FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(car)
```

## Data import  

```{r, message=FALSE}
NHANES <- read_csv("https://raw.githubusercontent.com/GTPB/PSLS20/master/data/NHANES.csv")
glimpse(NHANES[,1:10])
```

## Goal

In this tutorial, we will look at

1. Sampling
2. Non-paramtric data analysis

Everyone will take a different subsample of the NHANES
dataset. More specifically, you will first need to subsample
15 female and 15 male subjects for which information on
their BMI value is available (not an NA value). 

Then, will perform a statistical test to find out
if, for this specific subsample, the BMI values are
significantly different between male and female subjects.

Step by step:

1. Set a seed with the `set.seed()` function. Everyone should
pick a different seed, for instance, based on the order in 
which everyone is positioned in the classroom.

2. Filter out subjects with an NA value for BMI
3. Group the data by Gender
4. Sample 15 subjects of each Gender (look at the `sample_n` function)
5. Make a boxplot of the BMI values for both genders.
6. Use the `pull` function to get two vectors with the BMI values for
females and males, respectively.

7. Check the assumptions for performing an unpaired, two-sample t-test. 
If the assumptions are not met, perform a Wilcoxon rank-sum test.

8. Write a proper conclusion to answer the research question


## Steps 1-4

```{r}
set.seed(2)
NHANES_subset <- NHANES %>%
  filter(!is.na(BMI)) %>%
  group_by(Gender) %>% 
  sample_n(15) 

NHANES_subset
```


## Step 5

```{r}
NHANES_subset %>%
  ggplot(aes(x=Gender,y=BMI,fill=Gender)) + 
  scale_fill_brewer(palette="RdGy") +
  theme_bw() +
  geom_boxplot(outlier.shape=NA) + 
  geom_jitter(width = 0.2) +
  ggtitle("Boxplot of the BMI values of both Genders in the subset") +
  ylab("BMI (kg/m2)") + 
  stat_summary(fun.y=mean, geom="point", shape=5, size=3, color="black", fill="black")
```

We observe three very strong outliers in the female subset,
already suggesting that the data might not be normally
distributed.

## Step 6

```{r}
female_BMI <- NHANES_subset %>%
  filter(Gender == "female") %>%
  pull("BMI")

male_BMI <- NHANES_subset %>%
  filter(Gender == "male") %>%
  pull("BMI")
```


## Step 7

The unpaired, two-sample t-test has 2 assumptions:

1. The observations are independent of each other (in both groups)
2. The data (rel) must be normally distributed (in both groups)

Additionaly, we should check if the variability within both groups 
is similar.

The first assumption is met, as we may assume that there are no
specific patterns of correlation in our group of 16 randomly
select subjects.

To check the normality assumption, we will use QQ plots.

```{r}
par(mfrow=c(1,2))
qqPlot(female_BMI)
qqPlot(male_BMI)
```

We clearly see that we have clear deviations from
normality. Three datapoints in the female subset and two 
datapoints in the male subset do not fall within the 95% 
confidence interval around the quantile-quantile
line (blue dashed line). As such, we may conclude that 
our data is not normally distributed.

We also need to check if the variances are comparable between
the two groups. To do so, we may use the var.test function 
that we saw in the second tutorial.

```{r}
var.test(female_BMI,male_BMI)
```

The null hypothesis that the true ratio of variances 
equals 1 (i.e. that the variances are equal) is rejected,
so we may assume that the variances are not equal.

As the assumption of normality is violated, we are not allowed 
to continue performing the t-test. As an alternative, we may 
perform a non-parametric test, such as the Wilcoxon rank-sum test.


## Step 8

```{r}
wilcox.test(female_BMI,male_BMI)
```

We find that the test is not significant on the 5%
significance level (p = 0.02509).

We can manually calculate this probability, that is 50% 
under the null hypothesis, based on the observed test statistic.

```{r}
n1 <- n2 <- 15 #15 observations in each group
WObs <- wilcox.test(BMI~Gender, data=NHANES_subset)$statistic # get the observed test statistic
WObs/(n1*n2)
```

We can see taht the point estimation of this probability 
is `r round(WObs/(n1*n2),3)*100`%.

We can interpret this as follows;

The probability that the BMI of a random female subject is 
greater than or equal to the BMI in a random male subject 
is equal to 25.8%.

This chance is not significantly different from 50% on the
5% significance level (p = 0.02509).

## Large subset

Typically, the experiments that we perform are relatively
small. For instance, it is not unthinkable that we perform
analysis between two groups with 15 observations per group,
as we have performed above.

However, for different subsamples the results may vary greatly!
So, if we perform such small experiments, it is always tricky
to know how well we can extrapolate the results to the desired
population. 

Here, for the NHANES dataset, we do have (almost) have a ground 
truth for the experiment: in the full dataset thousands of subjects
have provided us with BMI values. As such, we can repeat the 
analysis on a much larger subsample of the data (or all of it),
to see which of the different seeds had a result closest to reality.

Let's sample 400 male and female subjects:

```{r}
set.seed(1)
NHANES_subset <- NHANES %>%
  filter(!is.na(BMI)) %>%
  group_by(Gender) %>% 
  sample_n(100) 
```

Plot the data

```{r}
NHANES_subset %>%
  ggplot(aes(x=Gender,y=BMI,fill=Gender)) + 
  scale_fill_brewer(palette="RdGy") +
  theme_bw() +
  geom_boxplot(outlier.shape=NA) + 
  geom_jitter(width = 0.2) +
  ggtitle("Boxplot of the BMI values of both Genders in the subset") +
  ylab("BMI (kg/m2)") + 
  stat_summary(fun.y=mean, geom="point", shape=5, size=3, color="black", fill="black")
```

Check the assumption of normality

```{r}
female_BMI <- NHANES_subset %>%
  filter(Gender == "female") %>%
  pull("BMI")

male_BMI <- NHANES_subset %>%
  filter(Gender == "male") %>%
  pull("BMI")

par(mfrow=c(1,2))
qqPlot(female_BMI)
qqPlot(male_BMI)
```

The assumption of normality is not met. Here,
we will resort to the non-parametric Wilcox
rank-sum test. **Alternatively**, one may perform
a logarithmic transformation of the data to
(possibly) obtain normally distributed data.


```{r}
wilcox.test(female_BMI,male_BMI)

n1 <- n2 <- 100 #15 observations in each group
WObs <- wilcox.test(BMI~Gender, data=NHANES_subset)$statistic # get the observed test statistic
WObs/(n1*n2)
```

** Conclusion **

The probability that the BMI of a random female subject is 
greater than or equal to the BMI in a random male subject 
is equal to 49.4%.

This chance is not significantly different from 50% on the
5% significance level (p = 0.8921).

This result is, for instance, completely in contrast with
the result of the person who used set.seed(1) in the 
analysis on the small sample size. It is clear that having
a large enough sample size is required to get meaningful
results and to extrapolate them to the population.













